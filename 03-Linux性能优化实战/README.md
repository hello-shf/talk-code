#### [01 | 如何学习Linux性能优化？](https://time.geekbang.org/column/article/69346)

> 笔记

* 性能指标
![性能指标.png](https://github.com/hello-shf/talk-code/blob/master/images/性能指标.png?raw=true)
* 技术路线
![技术路线.png](https://github.com/hello-shf/talk-code/blob/master/images/技术路线.png?raw=true)
* 怎么学更高效？
    * 虽然系统的原理很重要，但在刚开始一定不要试图抓住所有的实现细节。
    * 边学边实践，通过大量的案例演习掌握 Linux 性能的分析和优化。
    * 勤思考，多反思，善总结，多问为什么。


#### [02 | 基础篇：到底应该怎么理解“平均负载”？](https://time.geekbang.org/column/article/69618)

> 笔记

* 平均负载
    * 平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系。
        * 可运行状态
            * 所谓可运行状态的进程，是指正在使用 CPU 或者正在等待 CPU 的进程，也就是我们常用 ps 命令看到的，处于 R 状态（Running 或 Runnable）的进程
        * 不可中断状态
            * 不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是我们在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程。
* $ uptime

| 当前时间 | 系统运行时间 | 当前用户数 | 过去1分钟 | 过去5分钟 | 过去15分钟 |
| :---: | :---: | :----: | :---: | :---: | :---: |
| 02:34:03 up 2 days | 20:14 | 1 user | load average: 0.63 | 0.83 | 0.88 |

* 平均负载为多少时合理？
    * 首先需要知道有多少 CPU
        * lscpu |grep CPU
        * grep 'model name' /proc/cpuinfo | wc -l
    * 如果 1 分钟、5 分钟、15 分钟的三个值基本相同，或者相差不大，那就说明系统负载很平稳。
    * 但如果 1 分钟的值远小于 15 分钟的值，就说明系统最近 1 分钟的负载在减少，而过去 15 分钟内却有很大的负载。
    * 如果 1 分钟的值远大于 15 分钟的值，就说明最近 1 分钟的负载在增加，这种增加有可能只是临时性的，也有可能还会持续增加下去，所以就需要持续观察。一旦 1 分钟的平均负载接近或超过了 CPU 的个数，就意味着系统正在发生过载的问题，这时就得分析调查是哪里导致的问题，并要想办法优化了。
这里我再举个例子，假设我们在一个单 CPU 系统上看到平均负载为 1.73，0.60，7.98，那么说明在过去 1 分钟内，系统有 73% 的超载，而在 15 分钟内，有 698% 的超载，从整体趋势来看，系统的负载在降低。
    * 经验值 ：当平均负载高于 CPU 数量 **70%** 的时候
* 平均负载 & CPU 使用率
    * 区别
        * CPU使用率：指的是 正在使用CPU的进程。
        * 平均负载：正在使用CPU + 正在等待CPU + 正在等待 I/O的进程
    * 两者并不能完全对应
        * **CPU 密集型进程** 一致，使用大量 CPU 会导致平均负载升高
        * **I/O 密集型进程** 不一致，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；
        * 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高
* 安装 stress & sysstat 进行实操
    * stress 是一个 Linux 系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场景
    * sysstat 包含了常用的 Linux 性能工具，用来监控和分析系统的性能。我们的案例会用到这个包的两个命令 mpstat 和 pidstat。
        * mpstat 是一个常用的多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，以及所有 CPU 的平均指标。
        * pidstat 是一个常用的进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及上下文切换等性能指标。